<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Library Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons for nice UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        th {
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background-color: #e2e8f0;
        }
        .modal-active {
            display: flex !important;
        }
        /* Smooth expand/collapse animation */
        .details-row {
            transition: all 0.3s ease-in-out;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="p-4 sm:p-6 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 flex items-center gap-3">
                    <i data-lucide="library" class="w-8 h-8 text-indigo-600"></i>
                    Library Inventory
                </h1>
                <p class="text-slate-500 text-sm mt-1">Real-time shared book tracking</p>
            </div>
            <div id="user-info" class="text-sm font-medium text-indigo-800 bg-indigo-50 px-4 py-2 rounded-full border border-indigo-100 flex items-center gap-2">
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Connecting...
            </div>
        </header>

        <!-- ADD/EDIT FORM -->
        <details class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 group">
            <summary id="form-summary" class="text-xl font-bold text-slate-800 flex items-center gap-2 cursor-pointer list-none">
                <span id="form-title-text" class="flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Add New Book</span>
                <span class="text-sm text-slate-400 font-normal ml-auto group-open:hidden">Click to expand form</span>
            </summary>

            <form id="book-form" class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-6">
                <input type="hidden" id="edit-doc-id" value="">

                <!-- ROW 1: Core Info -->
                <div class="md:col-span-3 flex gap-2 items-end">
                     <div class="flex-grow">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ISBN</label>
                        <input type="text" id="isbn" placeholder="e.g., 978-..." 
                           class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
                     </div>
                     <button type="button" id="btn-unknown-isbn" title="Set to Unknown" class="mb-[1px] p-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                     </button>
                </div>
                <div class="md:col-span-5">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Book Title *</label>
                    <input type="text" id="title" placeholder="Full Title" required
                           class="w-full p-2.5 bg-slate-50 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
                </div>
                <div class="md:col-span-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Author *</label>
                    <input type="text" id="author" placeholder="Primary Author" required
                           class="w-full p-2.5 bg-slate-50 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
                </div>

                <!-- ROW 2: Logistics -->
                <div class="md:col-span-2">
                     <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Qty</label>
                    <input type="number" id="availableAmount" placeholder="1" min="0" value="1"
                           class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Location</label>
                    <input type="text" id="location" placeholder="e.g., Shelf A3"
                           class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                </div>
                 <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">State of Book</label>
                    <select id="state" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                        <option value="">Unknown State</option>
                        <option value="Good as new/New">Good as new/New</option>
                        <option value="Usable">Usable</option>
                        <option value="Needs replacement">Needs replacement</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Genre</label>
                    <input type="text" id="genre" placeholder="e.g., Sci-Fi" list="genre-options"
                           class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                    <datalist id="genre-options">
                        <option value="Fiction"></option><option value="Non-Fiction"></option><option value="Fantasy"></option>
                        <option value="Sci-Fi"></option><option value="Mystery"></option><option value="History"></option>
                    </datalist>
                </div>

                <!-- ROW 3: Extra Details (Collapsed by default in mind, but here we show them) -->
                 <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pub. Year</label>
                    <input type="text" id="pubDate" placeholder="e.g., 2023"
                           class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                </div>
                <div class="md:col-span-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Language</label>
                    <input type="text" id="language" placeholder="e.g., English" list="lang-options"
                           class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                     <datalist id="lang-options">
                        <option value="English"></option><option value="Spanish"></option><option value="French"></option>
                     </datalist>
                </div>
                 <div class="md:col-span-5">
                     <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Difficulty</label>
                     <input type="text" id="difficulty" placeholder="e.g., Intermediate" list="diff-options"
                        class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                     <datalist id="diff-options">
                         <option value="Beginner"></option><option value="Intermediate"></option><option value="Advanced"></option><option value="To be determined"></option>
                     </datalist>
                </div>

                <!-- FORM ACTIONS -->
                <div class="md:col-span-12 mt-4 flex gap-3">
                    <button type="submit" id="submit-btn"
                            class="flex-grow bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span id="submit-text">Add to Inventory</span>
                    </button>
                    <button type="button" id="cancel-edit" class="hidden px-6 py-3 border border-red-200 text-red-700 hover:bg-red-50 rounded-lg font-semibold transition-all">
                        Cancel
                    </button>
                </div>
            </form>
        </details>

        <!-- INVENTORY SECTION -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            
            <!-- ADVANCED FILTER BAR -->
            <div class="p-4 bg-slate-50 border-b border-slate-200 grid grid-cols-1 md:grid-cols-12 gap-3">
                <!-- General Search -->
                <div class="md:col-span-4 relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                    <input type="text" id="filter-general" placeholder="Search title, author, ISBN..."
                        class="w-full pl-10 p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Specific Filters -->
                <div class="md:col-span-2">
                    <select id="filter-state" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-slate-700">
                        <option value="">All States</option>
                        <option value="Good as new/New">Good as New</option>
                        <option value="Usable">Usable</option>
                        <option value="Needs replacement">Needs Replacement</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <select id="filter-genre" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-slate-700">
                        <option value="">All Genres</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="md:col-span-2">
                     <input type="text" id="filter-location" placeholder="Filter Location"
                        class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Tools -->
                <div class="md:col-span-2 flex items-center justify-end gap-2">
                    <!-- Group Toggle -->
                    <label class="flex items-center cursor-pointer select-none" title="Merge identical books">
                        <div class="relative">
                            <input type="checkbox" id="group-toggle" class="sr-only">
                            <div class="block bg-slate-300 w-10 h-6 rounded-full transition-colors toggle-bg"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                        </div>
                        <span class="ml-2 text-sm font-semibold text-slate-600"><i data-lucide="layers" class="inline w-4 h-4"></i></span>
                    </label>
                    <!-- Export -->
                     <button id="export-btn" title="Export CSV" class="p-2.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <style>
                #group-toggle:checked ~ .toggle-bg { background-color: #4f46e5; }
                #group-toggle:checked ~ .dot { transform: translateX(100%); }
            </style>

            <!-- TABLE -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100 text-slate-700">
                        <tr>
                            <th class="w-10 px-4 py-3"></th> <!-- Expander Column -->
                            <th data-sort="title" class="px-4 py-3 text-xs font-bold uppercase tracking-wider text-left group hover:text-indigo-600">
                                <div class="flex items-center gap-1">Title <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-40 group-hover:opacity-100"></i></div>
                            </th>
                            <th data-sort="author" class="px-4 py-3 text-xs font-bold uppercase tracking-wider text-left group hover:text-indigo-600">
                                <div class="flex items-center gap-1">Author <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-40 group-hover:opacity-100"></i></div>
                            </th>
                            <th data-sort="state" class="px-4 py-3 text-xs font-bold uppercase tracking-wider text-left group hover:text-indigo-600 w-32">
                                <div class="flex items-center gap-1">State <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-40 group-hover:opacity-100"></i></div>
                            </th>
                            <th data-sort="location" class="px-4 py-3 text-xs font-bold uppercase tracking-wider text-left hidden sm:table-cell group hover:text-indigo-600">
                                <div class="flex items-center gap-1">Loc <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-40 group-hover:opacity-100"></i></div>
                            </th>
                             <th data-sort="availableAmount" class="px-4 py-3 text-xs font-bold uppercase tracking-wider text-center group hover:text-indigo-600 w-24">
                                <div class="flex items-center justify-center gap-1">Qty <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-40 group-hover:opacity-100"></i></div>
                            </th>
                            <th class="px-4 py-3 text-xs font-bold uppercase tracking-wider text-right w-24">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list" class="bg-white divide-y divide-slate-200">
                         <!-- Rows injected by JS -->
                    </tbody>
                </table>

                <!-- Loading/Empty States -->
                <div id="loading" class="text-center py-12 text-indigo-600 font-semibold flex flex-col items-center">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4"></i>
                    Loading library data...
                </div>
                <div id="empty-state" class="hidden text-center py-16 text-slate-400 flex flex-col items-center">
                    <i data-lucide="book-dashed" class="w-16 h-16 text-slate-200 mb-4"></i>
                    <p class="text-lg font-medium text-slate-500">No books match your filters.</p>
                    <p class="text-sm">Try adjusting your search terms.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL -->
    <div id="delete-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-200">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600 mx-auto">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900 text-center mb-2">Delete Book?</h3>
            <p class="text-slate-600 text-center mb-6">This action cannot be undone. Are you sure you want to remove this book?</p>
            <div class="flex gap-3">
                <button id="cancel-delete" class="flex-1 px-4 py-2.5 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition">Cancel</button>
                <button id="confirm-delete" class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // ====================================================================================
        // !!! IMPORTANT: FIREBASE CONFIGURATION FOR DEPLOYMENT !!!
        // To make this app work on GitHub Pages, Vercel, etc., you MUST replace the values 
        // in this object with your actual Firebase Web App credentials.
        const PLACEHOLDER_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_AUTH_DOMAIN_HERE",
            projectId: "YOUR_PROJECT_ID_HERE",
            storageBucket: "YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
            appId: "YOUR_APP_ID_HERE"
        };
        // ====================================================================================

        // Check for Canvas config first, otherwise use the hardcoded config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : PLACEHOLDER_FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-public-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        // Flag is true if we have a real projectId (i.e., not the placeholder)
        let isConnected = firebaseConfig.projectId !== "YOUR_PROJECT_ID_HERE"; 
        let allBooks = [];
        let currentSort = { field: 'timestamp', dir: 'desc' };
        let bookToDeleteId = null;
        
        const els = {
            userInfo: document.getElementById('user-info'),
            formSummary: document.getElementById('form-summary'),
            formDetails: document.querySelector('details'),
            formTitleText: document.getElementById('form-title-text'),
            form: document.getElementById('book-form'),
            submitBtn: document.getElementById('submit-btn'),
            submitText: document.getElementById('submit-text'),
            cancelEditBtn: document.getElementById('cancel-edit'),
            editDocId: document.getElementById('edit-doc-id'),
            list: document.getElementById('inventory-list'),
            loading: document.getElementById('loading'),
            empty: document.getElementById('empty-state'),
            
            // Filters
            filterGeneral: document.getElementById('filter-general'),
            filterState: document.getElementById('filter-state'),
            filterGenre: document.getElementById('filter-genre'),
            filterLocation: document.getElementById('filter-location'),
            groupToggle: document.getElementById('group-toggle'),
            
            deleteModal: document.getElementById('delete-modal'),
            confirmDeleteBtn: document.getElementById('confirm-delete'),
            cancelDeleteBtn: document.getElementById('cancel-delete'),
            exportBtn: document.getElementById('export-btn'),
            unknownIsbnBtn: document.getElementById('btn-unknown-isbn')
        };

        function escapeHtml(str) { return str ? String(str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : ''; }

        // --- Firebase Initialization ---
        async function initFirebase() {
            if (!isConnected) {
                // If not configured, show error and stop
                els.userInfo.innerHTML = `<i data-lucide="x-octagon" class="w-4 h-4 text-red-600"></i> Disconnected (Config Missing)`;
                els.userInfo.className = 'text-sm font-medium text-red-800 bg-red-50 px-4 py-2 rounded-full border border-red-100 flex items-center gap-2';
                els.loading.innerHTML = '<i data-lucide="alert-triangle" class="w-8 h-8 text-red-600 mb-4"></i><p>Firebase configuration is missing. Please edit the code to add your credentials.</p>';
                lucide.createIcons();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authentication
                if (initialAuthToken) {
                    // Use custom token (Canvas environment)
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Use anonymous sign-in (Public deployment)
                    await signInAnonymously(auth);
                }
                
                // 2. Auth State Change Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        els.userInfo.innerHTML = `<i data-lucide="wifi" class="w-4 h-4 text-emerald-600"></i> Connected (Shared) - User ID: ${userId.substring(0, 8)}...`;
                        els.userInfo.className = 'text-sm font-medium text-emerald-800 bg-emerald-50 px-4 py-2 rounded-full border border-emerald-100 flex items-center gap-2';
                        lucide.createIcons();
                        // 3. Start Firestore Listener
                        startFirestoreListener();
                    } else {
                        console.log("Not signed in.");
                    }
                });

            } catch (error) {
                 console.error("Firebase initialization failed:", error);
                 els.userInfo.innerHTML = `<i data-lucide="alert-circle" class="w-4 h-4 text-red-600"></i> Error`;
                 els.userInfo.className = 'text-sm font-medium text-red-800 bg-red-50 px-4 py-2 rounded-full border border-red-100 flex items-center gap-2';
                 lucide.createIcons();
            }
        }

        function startFirestoreListener() {
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'library_books')), (snapshot) => {
                allBooks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateGenreFilterDropdown();
                renderTable();
                els.loading.classList.add('hidden');
            });
        }
        
        // --- Filtering Logic ---

        function updateGenreFilterDropdown() {
            const genres = [...new Set(allBooks.map(b => b.genre).filter(g => g && g.trim() !== ''))].sort();
            const currentVal = els.filterGenre.value;
            els.filterGenre.innerHTML = '<option value="">All Genres</option>' + 
                genres.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
            els.filterGenre.value = currentVal; // Maintain selection if possible
        }

        function getFilteredAndSortedBooks() {
            let data = [...allBooks];

            // 1. General Search
            const genTerm = els.filterGeneral.value.toLowerCase();
            if (genTerm) {
                data = data.filter(b => (b.title||'').toLowerCase().includes(genTerm) || (b.author||'').toLowerCase().includes(genTerm) || (b.isbn||'').toLowerCase().includes(genTerm));
            }
            // 2. Specific Filters
            if (els.filterState.value) data = data.filter(b => b.state === els.filterState.value);
            if (els.filterGenre.value) data = data.filter(b => b.genre === els.filterGenre.value);
            if (els.filterLocation.value) data = data.filter(b => (b.location||'').toLowerCase().includes(els.filterLocation.value.toLowerCase()));

            // 3. Grouping
            if (els.groupToggle.checked) data = groupBooks(data);

            // 4. Sorting
            data.sort((a, b) => {
                let valA = (a[currentSort.field] || '').toString().toLowerCase();
                let valB = (b[currentSort.field] || '').toString().toLowerCase();
                if (currentSort.field === 'availableAmount') { valA = Number(a.availableAmount)||0; valB = Number(b.availableAmount)||0; }
                if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                // Secondary sort by title
                if (a.title < b.title) return -1;
                if (a.title > b.title) return 1;
                return 0;
            });

            return data;
        }

        function groupBooks(books) {
            const groups = {};
            books.forEach(book => {
                const key = `${(book.title||'').toLowerCase()}|${(book.author||'').toLowerCase()}|${(book.language||'').toLowerCase()}|${(book.state||'').toLowerCase()}`;
                if (!groups[key]) {
                    groups[key] = { ...book, isGroup: false };
                } else {
                    groups[key].isGroup = true;
                    groups[key].availableAmount = (Number(groups[key].availableAmount)||0) + (Number(book.availableAmount)||0);
                    if (book.location && !groups[key].location.includes(book.location)) {
                         groups[key].location = groups[key].location ? `${groups[key].location}, ${book.location}` : book.location;
                    }
                }
            });
            return Object.values(groups);
        }

        // --- Rendering ---
        function renderTable() {
            const displayData = getFilteredAndSortedBooks();
            if (displayData.length === 0) { els.list.innerHTML = ''; els.empty.classList.remove('hidden'); return; }
            els.empty.classList.add('hidden');

            els.list.innerHTML = displayData.map(book => {
                const isGroup = !!book.isGroup;
                const qty = book.availableAmount || 0;
                const qtyClass = qty > 0 ? 'text-emerald-700 bg-emerald-50 border-emerald-100' : 'text-red-700 bg-red-50 border-red-100';
                
                // State Badge Logic
                let stateBadge = '<span class="text-slate-400">—</span>';
                if (book.state === 'Good as new/New') stateBadge = '<span class="px-2 py-1 text-xs font-medium bg-emerald-100 text-emerald-800 rounded-full">New/Good</span>';
                else if (book.state === 'Usable') stateBadge = '<span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-800 rounded-full">Usable</span>';
                else if (book.state === 'Needs replacement') stateBadge = '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Replace</span>';

                return `
                <!-- MAIN ROW -->
                <tr class="hover:bg-slate-50 transition-colors ${isGroup ? 'bg-indigo-50/30' : ''}">
                    <td class="px-4 py-3 text-center">
                        <button onclick="window.toggleDetails('${book.id}', this)" class="p-1 hover:bg-slate-200 rounded transition-transform duration-200">
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-semibold text-slate-900">${escapeHtml(book.title)}</div>
                        ${isGroup ? '<span class="text-xs text-indigo-600 font-medium"><i data-lucide="layers" class="inline w-3 h-3"></i> Grouped</span>' : ''}
                    </td>
                    <td class="px-4 py-3 text-slate-700">${escapeHtml(book.author)}</td>
                    <td class="px-4 py-3">${stateBadge}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 hidden sm:table-cell">${escapeHtml(book.location || '—')}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2.5 py-1 rounded-md text-sm font-bold border ${qtyClass}">${qty}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        ${isGroup ? '<span class="text-xs text-slate-400 italic select-none">Ungroup to edit</span>' : 
                            `<div class="flex justify-end gap-1">
                                <button onclick="window.edit('${book.id}')" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-md transition" title="Edit"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="window.del('${book.id}')" class="p-2 text-red-600 hover:bg-red-100 rounded-md transition" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>`
                        }
                    </td>
                </tr>
                <!-- EXPANDABLE DETAILS ROW -->
                <tr id="details-${book.id}" class="hidden bg-slate-50/50 shadow-inner">
                    <td colspan="7" class="px-4 md:px-14 py-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div><span class="block text-xs font-bold text-slate-500 uppercase">ISBN</span> <span class="font-mono text-slate-700">${escapeHtml(book.isbn || '—')}</span></div>
                            <div><span class="block text-xs font-bold text-slate-500 uppercase">Genre</span> <span class="text-slate-700">${escapeHtml(book.genre || '—')}</span></div>
                            <div><span class="block text-xs font-bold text-slate-500 uppercase">Language</span> <span class="text-slate-700">${escapeHtml(book.language || '—')}</span></div>
                            <div><span class="block text-xs font-bold text-slate-500 uppercase">Pub. Year</span> <span class="text-slate-700">${escapeHtml(book.pubDate || '—')}</span></div>
                            <div><span class="block text-xs font-bold text-slate-500 uppercase">Difficulty</span> <span class="text-slate-700">${escapeHtml(book.difficulty || '—')}</span></div>
                            <div class="sm:hidden"><span class="block text-xs font-bold text-slate-500 uppercase">Location</span> <span class="text-slate-700">${escapeHtml(book.location || '—')}</span></div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        // --- Interactions (CRUD) ---
        window.toggleDetails = (id, btn) => {
            const row = document.getElementById(`details-${id}`);
            const isHidden = row.classList.contains('hidden');
            row.classList.toggle('hidden');
            btn.querySelector('svg').style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
        };

        // Form & Action Handling
        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;
            els.submitBtn.disabled = true; els.submitBtn.classList.add('opacity-70'); els.submitText.textContent = 'Saving...';
            
            const data = {
                isbn: document.getElementById('isbn').value.trim(),
                title: document.getElementById('title').value.trim(),
                author: document.getElementById('author').value.trim(),
                availableAmount: Math.max(0, parseInt(document.getElementById('availableAmount').value)||0),
                location: document.getElementById('location').value.trim(),
                state: document.getElementById('state').value,
                genre: document.getElementById('genre').value.trim(),
                pubDate: document.getElementById('pubDate').value.trim(),
                language: document.getElementById('language').value.trim(),
                difficulty: document.getElementById('difficulty').value.trim(),
                lastEditedBy: userId,
                timestamp: serverTimestamp() // Always use server timestamp for Firebase
            };

            try {
                if (els.editDocId.value) {
                    // UPDATE
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'library_books', els.editDocId.value), data);
                } else {
                    // CREATE
                    data.addedBy = userId;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'library_books'), data);
                }
                resetForm();
            } catch (err) { 
                console.error("Save failed:", err);
            } 
            finally { 
                els.submitBtn.disabled = false; els.submitBtn.classList.remove('opacity-70'); updateBtnState(); 
            }
        });

        window.edit = (id) => {
            const b = allBooks.find(book => book.id === id);
            if (!b) return;
            els.editDocId.value = b.id;
            ['isbn','title','author','location','state','genre','pubDate','language','difficulty'].forEach(f => document.getElementById(f).value = b[f] || '');
            document.getElementById('availableAmount').value = b.availableAmount ?? 1;
            els.formDetails.open = true; // Auto-expand form
            els.formTitleText.innerHTML = '<i data-lucide="edit-3" class="w-5 h-5 text-indigo-600"></i> Editing Book';
            els.formDetails.scrollIntoView({ behavior: 'smooth' });
            updateBtnState(); lucide.createIcons();
        };

        function resetForm() {
            els.form.reset(); els.editDocId.value = '';
            document.getElementById('availableAmount').value = 1;
            els.formTitleText.innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Add New Book';
            updateBtnState(); lucide.createIcons();
        }
        function updateBtnState() {
            const isEdit = !!els.editDocId.value;
            els.submitText.textContent = isEdit ? 'Update Book' : 'Add to Inventory';
            els.cancelEditBtn.classList.toggle('hidden', !isEdit);
        }

        window.del = (id) => { bookToDeleteId = id; els.deleteModal.classList.add('modal-active'); };
        els.confirmDeleteBtn.onclick = async () => {
            try {
                if (bookToDeleteId) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'library_books', bookToDeleteId));
                }
            } catch (err) {
                console.error("Delete failed:", err);
            }
            els.deleteModal.classList.remove('modal-active');
        };
        els.cancelDeleteBtn.onclick = () => els.deleteModal.classList.remove('modal-active');
        els.cancelEditBtn.onclick = resetForm;
        els.unknownIsbnBtn.onclick = () => document.getElementById('isbn').value = 'Unknown';

        // Filter Events
        ['filterGeneral', 'filterState', 'filterGenre', 'filterLocation'].forEach(id => els[id].addEventListener('input', renderTable));
        els.groupToggle.addEventListener('change', renderTable);
        document.querySelectorAll('th[data-sort]').forEach(th => th.addEventListener('click', () => {
            const f = th.dataset.sort;
            currentSort.dir = (currentSort.field === f && currentSort.dir === 'asc') ? 'desc' : 'asc';
            currentSort.field = f; renderTable();
        }));

        els.exportBtn.onclick = () => {
             if (allBooks.length === 0) return alert("Nothing to export.");
             const csv = ["ISBN,Title,Author,Qty,Location,State,Genre,Language,PubYear,Difficulty"].join(",") + "\n" +
                 allBooks.map(b => [b.isbn,b.title,b.author,b.availableAmount,b.location,b.state,b.genre,b.language,b.pubDate,b.difficulty].map(f => `"${(f||'').toString().replace(/"/g,'""')}"`).join(",")).join("\n");
             const link = document.createElement("a");
             link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
             link.download = `library_${new Date().toISOString().slice(0,10)}.csv`;
             link.click();
        };

        initFirebase();
    </script>
</body>
</html>
